name: å‘å¸ƒåˆ° PyPI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚: 0.2.1)'
        required: true
        type: string
      test_pypi:
        description: 'å‘å¸ƒåˆ°æµ‹è¯• PyPI'
        required: false
        type: boolean
        default: false

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: èŽ·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          # ä»Ž Release æ ‡ç­¾èŽ·å–ç‰ˆæœ¬å·
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
        else
          # ä»Žæ‰‹åŠ¨è¾“å…¥èŽ·å–ç‰ˆæœ¬å·
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="false"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "å‘å¸ƒç‰ˆæœ¬: $VERSION"
        echo "é¢„å‘å¸ƒ: $IS_PRERELEASE"
        
    - name: æ›´æ–°ç‰ˆæœ¬å·
      if: github.event_name == 'workflow_dispatch'
      run: |
        cd packages/yai-loguru-sinks
        sed -i "s/version = \".*\"/version = \"${{ steps.version.outputs.version }}\"/" pyproject.toml
        
    - name: æž„å»ºåŒ…
      run: |
        cd packages/yai-loguru-sinks
        uv build
        
    - name: æ£€æŸ¥åŒ…
      run: |
        cd packages/yai-loguru-sinks
        uv run --with twine twine check dist/*
        
    - name: æ˜¾ç¤ºåŒ…ä¿¡æ¯
      run: |
        cd packages/yai-loguru-sinks
        ls -la dist/
        echo "=== åŒ…å†…å®¹ ==="
        uv run --with twine twine check dist/* --strict
        
    - name: å‘å¸ƒåˆ°æµ‹è¯• PyPI
      if: |
        (github.event_name == 'release' && github.event.release.prerelease == true) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'true')
      env:
        UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        cd packages/yai-loguru-sinks
        echo "å‘å¸ƒåˆ°æµ‹è¯• PyPI..."
        uv publish --repository testpypi
        
    - name: å‘å¸ƒåˆ°æ­£å¼ PyPI
      if: |
        (github.event_name == 'release' && github.event.release.prerelease == false) ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.test_pypi == 'false')
      env:
        UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        cd packages/yai-loguru-sinks
        echo "å‘å¸ƒåˆ°æ­£å¼ PyPI..."
        uv publish
        
    - name: æäº¤ç‰ˆæœ¬æ›´æ–°
      if: github.event_name == 'workflow_dispatch'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add packages/yai-loguru-sinks/pyproject.toml
        git commit -m "bump: æ›´æ–° yai-loguru-sinks ç‰ˆæœ¬åˆ° ${{ steps.version.outputs.version }}" || exit 0
        git push
        
    - name: åˆ›å»º Releaseï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
      if: github.event_name == 'workflow_dispatch'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PRERELEASE_FLAG=""
        if [[ "${{ github.event.inputs.test_pypi }}" == "true" ]]; then
          PRERELEASE_FLAG="--prerelease"
        fi
        
        cat > release-notes.md << EOF
        ## yai-loguru-sinks v${{ steps.version.outputs.version }}
        
        ### ðŸš€ æ–°åŠŸèƒ½
        - åŸºäºŽ sink å·¥åŽ‚çš„æž¶æž„è®¾è®¡
        - æ”¯æŒå¤šç§ sink ç±»åž‹ï¼ˆæ–‡ä»¶ã€æŽ§åˆ¶å°ã€JSONã€è‡ªå®šä¹‰ï¼‰
        - é…ç½®é©±åŠ¨çš„ sink ç®¡ç†
        - åè®®è§£æžå™¨æ”¯æŒ
        
        ### ðŸ“¦ å®‰è£…
        
        \`\`\`bash
        pip install yai-loguru-sinks==${{ steps.version.outputs.version }}
        \`\`\`
        
        ### ðŸ”§ ä½¿ç”¨ç¤ºä¾‹
        
        \`\`\`python
        from yai_loguru_sinks import SinkFactory
        from loguru import logger
        
        # åˆ›å»ºæ–‡ä»¶ sink
        sink = SinkFactory.create_file_sink("app.log")
        logger.add(sink)
        logger.info("Hello, World!")
        \`\`\`
        
        ### ðŸ“š æ–‡æ¡£
        
        - [ä½¿ç”¨æŒ‡å—](https://github.com/yai-nexus/loguru-suite/tree/main/packages/yai-loguru-sinks)
        - [ç¤ºä¾‹ä»£ç ](https://github.com/yai-nexus/loguru-suite/tree/main/examples)
        
        ### ðŸ”— ç›¸å…³é“¾æŽ¥
        
        - [PyPI é¡µé¢](https://pypi.org/project/yai-loguru-sinks/${{ steps.version.outputs.version }}/)
        - [æ›´æ–°æ—¥å¿—](https://github.com/yai-nexus/loguru-suite/releases)
        EOF
        
        gh release create "v${{ steps.version.outputs.version }}" \
          --title "yai-loguru-sinks v${{ steps.version.outputs.version }}" \
          --notes-file release-notes.md \
          $PRERELEASE_FLAG
          
    - name: å‘å¸ƒæ€»ç»“
      run: |
        echo "ðŸŽ‰ å‘å¸ƒå®Œæˆï¼"
        echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "PyPI: https://pypi.org/project/yai-loguru-sinks/${{ steps.version.outputs.version }}/"
        echo "Release: https://github.com/yai-nexus/loguru-suite/releases/tag/v${{ steps.version.outputs.version }}"