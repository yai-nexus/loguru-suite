name: å‘å¸ƒåˆ° PyPI

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v0.2.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 0.2.1)'
        required: true
        type: string
      test_pypi:
        description: 'å‘å¸ƒåˆ°æµ‹è¯• PyPI'
        required: false
        type: boolean
        default: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: æ›´æ–°ç‰ˆæœ¬å· (æ‰‹åŠ¨è§¦å‘æ—¶)
      if: github.event_name == 'workflow_dispatch'
      run: |
        cd packages/yai-loguru-sinks
        sed -i 's/version = ".*"/version = "${{ github.event.inputs.version }}"/' pyproject.toml
        
    - name: æ„å»ºåŒ…
      run: |
        cd packages/yai-loguru-sinks
        uv build
        
    - name: æ£€æŸ¥åŒ…å†…å®¹
      run: |
        cd packages/yai-loguru-sinks
        ls -la dist/
        
    - name: å‘å¸ƒåˆ°æµ‹è¯• PyPI
      if: github.event.inputs.test_pypi == 'true'
      env:
        UV_PUBLISH_USERNAME: __token__
        UV_PUBLISH_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        cd packages/yai-loguru-sinks
        uv publish --repository testpypi
        
    - name: å‘å¸ƒåˆ°æ­£å¼ PyPI
      if: github.event.inputs.test_pypi != 'true'
      env:
        UV_PUBLISH_USERNAME: __token__
        UV_PUBLISH_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        cd packages/yai-loguru-sinks
        uv publish
        
    - name: åˆ›å»º GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ yai-loguru-sinks ${{ github.ref_name }}
          
          ### ğŸ“¦ å®‰è£…
          ```bash
          pip install yai-loguru-sinks==${{ github.ref_name }}
          ```
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - [PyPI é¡µé¢](https://pypi.org/project/yai-loguru-sinks/${{ github.ref_name }}/)
          - [æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [ç¤ºä¾‹ä»£ç ](https://github.com/${{ github.repository }}/tree/main/examples)
        draft: false
        prerelease: false